---
title: "HW6"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

## Problem 1

Read in and tidy data
```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest" ~ 0,
      disposition == "Closed by arrest" ~ 1
    )
  ) %>% 
  filter(victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

Do this for one city...
```{r}
baltimore_df = 
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df, 
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = (exp(estimate) - 1.96 * std.error),
    CI_upper = (exp(estimate) + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

Do this for all cities
```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, 
                 ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = (exp(estimate) - 1.96 * std.error),
    CI_upper = (exp(estimate) + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI"))
```

```{r}
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR))+
  geom_point()+
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Problem 2
Compare on prediction error

First: build the models specified using the code from cross validation lecture

What model would work in this context? Start by picking variables that might be interesting and inserting them into models already known, look at residuals and see if there are patterns, are there any big issues in the dataset, etc.


Load in data as baby_df

weeks & bwt = lm(bwt ~ gaweeks, data = baby_df)
main effects only = lm(bwt ~ blength + gaweeks, data = baby_df)

Residuals:

baby_df %>% 
modelr::add_residuals(weeks & bwt) %>% 
ggplot(aes(x = gaweeks, y = resid)) %>% 
geom_point()


## Problem 3

Fit model to dataset, make sure you can compute adjusted R2 and the log betas term
broom::tidy, get estimated coefficients, may need to rearrange to get intercepts and estimates next to each other to multiply them

Figure out the model and calculations first, then figure out how to bootstrap it

Use plots to get R2 and CI for this


